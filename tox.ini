[tox]
envlist=pytest-check-x86, pytest-check-arm64, pytest-check-s390x, unused-code, utilities-unittests, utilities-test-quick, utilities-coverage
skipsdist=True

[testenv]
basepython = python3

[testenv:pytest-check-x86]
basepython = python3.12
recreate=True
setenv =
    PYTHONPATH = {toxinidir}
    LC_ALL = en_US.utf8
    LANG = en_US.utf8
    UV_PYTHON = python3.12
    OPENSHIFT_VIRTUALIZATION_TEST_IMAGES_ARCH = x86_64
deps=
    uv
commands =
    uv run pytest --tc-file=tests/global_config.py --collect-only
    uv run pytest --tc-file=tests/global_config.py --upgrade=cnv --cnv-image=NA --cnv-version=NA --collect-only
    uv run pytest --tc-file=tests/global_config.py --upgrade=ocp --ocp-image=NA --collect-only
    uv run pytest --tc-file=tests/global_config.py --upgrade=eus --eus-ocp-images=NA,NA --collect-only
    uv run pytest --tc-file=tests/global_config.py --upgrade_custom=cnv --cnv-image=NA --cnv-version=NA --collect-only
    uv run pytest --tc-file=tests/global_config.py --upgrade_custom=ocp --ocp-image=NA --collect-only
    uv run pytest --tc-file=tests/global_config_rh_it.py --collect-only
    uv run pytest --tc-file=tests/global_config.py -m smoke --collect-only
    uv run pytest --tc-file=tests/global_config.py --tc-format=python --setup-plan

[testenv:pytest-check-arm64]
basepython = python3.12
recreate=True
setenv =
    PYTHONPATH = {toxinidir}
    LC_ALL = en_US.utf8
    LANG = en_US.utf8
    UV_PYTHON = python3.12
    OPENSHIFT_VIRTUALIZATION_TEST_IMAGES_ARCH = arm64
deps=
    uv
commands =
    uv run pytest --tc-file=tests/global_config.py --collect-only -m arm64

[testenv:pytest-check-s390x]
basepython = python3.12
recreate=True
setenv =
 PYTHONPATH = {toxinidir}
 LC_ALL = en_US.utf8
 LANG = en_US.utf8
 UV_PYTHON = python3.12
 OPENSHIFT_VIRTUALIZATION_TEST_IMAGES_ARCH = s390x
deps=
 uv
commands =
 uv run pytest --tc-file=tests/global_config.py --collect-only  -m s390x


# Polarion
# Should run on every commit.
[testenv:verify-tc-requirement-polarion]
recreate=True
setenv =
    PYTHONPATH = {toxinidir}
deps:
    python-utility-scripts
commands =
    pyutils-polarion-verify-tc-requirements --project-id "CNV" --branch "origin/main"


# Should run only after merged.
[testenv:mark-automated-polarion]
recreate=True
setenv =
    PYTHONPATH = {toxinidir}
deps:
    python-utility-scripts
commands =
    pyutils-polarion-set-automated --project-id "CNV" {posargs}


#Jira
[testenv:verify-bugs-are-open]
recreate=True
setenv =
    PYTHONPATH = {toxinidir}
deps:
    python-utility-scripts
commands =
    pip install pip --upgrade
    pip install tox --upgrade
    pyutils-jira --config-file-path jira.cfg --target-versions "vfuture,4.20.0,4.20.z" --verbose

#Unused code
[testenv:unused-code]
recreate=True
setenv =
    PYTHONPATH = {toxinidir}
deps:
    python-utility-scripts
commands =
    pyutils-unusedcode --exclude-files "pytest_matrix_utils.py" --exclude-function-prefixes "pytest_"

# Utilities unit tests
[testenv:utilities-unittests]
basepython = python3.12
recreate = True
changedir = {toxinidir}/utilities
setenv =
    PYTHONPATH = {toxinidir}
    LC_ALL = en_US.utf8
    LANG = en_US.utf8
    UV_PYTHON = python3.12
deps =
    uv
commands =
    # Install dependencies and run working unit tests with coverage
    uv run pytest tests/test_architecture.py tests/test_bitwarden.py tests/test_console.py tests/test_constants.py tests/test_database.py tests/test_logger.py tests/test_exceptions.py tests/test_vnc_utils.py tests/test_must_gather.py tests/test_pytest_matrix_utils.py --cov=. --cov-report=term --cov-report=html:htmlcov --cov-report=xml --cov-report=json -v
    # Display coverage summary with error handling
    uv run python -c "print('\nüéØ Coverage Summary for Utility Modules:')"
    -uv run python -c "import json; data=json.load(open('coverage.json')); total=data['totals']; print('Overall Coverage: {:.2f}% ({}/{} lines)'.format(total['percent_covered'], total['covered_lines'], total['num_statements']))"
    # Alternative coverage display using coverage.py command
    -uv run coverage report --show-missing
    # Generate coverage badge data
    -uv run python -c "import json; data=json.load(open('coverage.json')); print('Coverage Badge: {:.1f}%'.format(data['totals']['percent_covered']))"

# Utilities unit tests (quick run without coverage)
[testenv:utilities-test-quick]
basepython = python3.12
recreate = True
changedir = {toxinidir}/utilities
setenv =
    PYTHONPATH = {toxinidir}
    LC_ALL = en_US.utf8
    LANG = en_US.utf8
    UV_PYTHON = python3.12
deps =
    uv
commands =
    # Run working unit tests without coverage for faster execution
    uv run pytest tests/test_architecture.py tests/test_bitwarden.py tests/test_console.py tests/test_constants.py tests/test_database.py tests/test_logger.py tests/test_exceptions.py tests/test_vnc_utils.py tests/test_must_gather.py tests/test_pytest_matrix_utils.py -v --tb=short

# Utilities coverage-only environment (no test execution, just coverage reporting)
[testenv:utilities-coverage]
basepython = python3.12
recreate = True
changedir = {toxinidir}/utilities
setenv =
    PYTHONPATH = {toxinidir}
    LC_ALL = en_US.utf8
    LANG = en_US.utf8
    UV_PYTHON = python3.12
deps =
    uv
commands =
    # Run tests with comprehensive coverage reporting
    uv run pytest tests/test_architecture.py tests/test_bitwarden.py tests/test_console.py tests/test_constants.py tests/test_database.py tests/test_logger.py tests/test_exceptions.py tests/test_vnc_utils.py tests/test_must_gather.py tests/test_pytest_matrix_utils.py --cov=. --cov-report=term-missing --cov-report=html:htmlcov --cov-report=xml --cov-report=json --cov-fail-under=95 -q
    # Display detailed coverage summary
    uv run python -c "print('\nüìä Detailed Coverage Report:')"
    -uv run coverage report --show-missing --skip-covered
    uv run python -c "print('\nüéØ Coverage Summary:')"
    -uv run python -c "import json; data=json.load(open('coverage.json')); total=data['totals']; print('Overall: {:.2f}% ({}/{} lines)'.format(total['percent_covered'], total['covered_lines'], total['num_statements'])); print('Missing: {} lines'.format(total['missing_lines']))"
    # Open coverage report instruction
    uv run python -c "import os; print(f'\nüìÅ HTML Report: file://{os.getcwd()}/htmlcov/index.html')"
